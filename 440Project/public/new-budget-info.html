<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Budget Info</title>
  </head>
  <body>
    <form id="budget-form" action="budget.html" method="post">
      <label for="Total_dollars">Total Dollars:</label>
      <input
        type="text"
        id="Total_dollars"
        name="Total_dollars"
        required
      /><br /><br />

      <label for="Categories_Amount">Amount of Categories:</label>
      <input
        type="text"
        id="Categories_amount"
        name="Categories_amount"
        required
      /><br /><br />

      <label for="Budget_length">Budget Time Length:</label>
      <select id="Budget_length" name="Budget_length" required>
        <option value="Daily">Daily</option>
        <option value="Weekly">Weekly</option>
        <option value="Monthly">Monthly</option>
        <option value="Yearly">Yearly</option>
      </select>
      <br /><br />

      <div id="category-fields"></div>

      <input type="submit" value="Submit" />
      <input type="reset" value="Reset" /><br /><br />
    </form>
    <script>
      const categoriesInput = document.getElementById("Categories_amount");
      const categoryFieldsContainer =
        document.getElementById("category-fields");

      categoriesInput.addEventListener("change", function () {
        const numberOfCategories = parseInt(this.value);
        categoryFieldsContainer.innerHTML = ""; // Clear previous fields

        if (!isNaN(numberOfCategories) && numberOfCategories > 0) {
          for (let i = 1; i <= numberOfCategories; i++) {
            // Container for each category
            const container = document.createElement("div");
            container.style.marginBottom = "15px";

            // Category Name
            const nameLabel = document.createElement("label");
            nameLabel.setAttribute("for", `category_${i}_name`);
            nameLabel.textContent = `Category ${i} Name:`;
            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.id = `category_${i}_name`;
            nameInput.name = `category_${i}_name`;
            nameInput.required = true;

            // Max Amount
            const amountLabel = document.createElement("label");
            amountLabel.setAttribute("for", `category_${i}_max`);
            amountLabel.textContent = ` Max Amount ($):`;
            const amountInput = document.createElement("input");
            amountInput.type = "number";
            amountInput.id = `category_${i}_max`;
            amountInput.name = `category_${i}_max`;
            amountInput.min = "0";
            amountInput.required = true;

            // Add to container
            container.appendChild(nameLabel);
            container.appendChild(nameInput);
            container.appendChild(document.createElement("br"));

            container.appendChild(amountLabel);
            container.appendChild(amountInput);
            container.appendChild(document.createElement("br"));

            categoryFieldsContainer.appendChild(container);
          }
        }
      });
      document
        .querySelector("form")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent the default form submission

          // Perform validation and registration logic here
          const totalDollars = parseFloat(
            document.getElementById("Total_dollars").value
          );
          const categoriesAmount = parseInt(
            document.getElementById("Categories_amount").value
          );
          const budgetLength = document
            .getElementById("Budget_length")
            .value.trim();
          const categoryData = collectCategoryData(categoriesAmount);
          if (!totalDollars || !categoriesAmount || !budgetLength) {
            alert("Please fill in all fields!");
            return;
          }
          var totalAmount = 0;
          categoryData.forEach(([name, amount]) => {
            totalAmount += amount; // Sum the amounts
          });
          if (totalAmount > totalDollars) {
            alert(
              "Total amount in combined categories exceeds the budget limit!"
            );
            return;
          }
          const userID = localStorage.getItem("userID");
          if (!userID) {
            alert("User ID not found. Please log in again.");
            return;
          }
          const response = await fetch("http://localhost:3000/budget", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              totalDollars,
              categoriesAmount,
              budgetLength,
              userID,
            }),
          });
          const data = await response.json(); // Parse the JSON response
          if (response.ok) {
            // Successful registration
            alert("Budget info submitted successfully!");
            const budgetID = data.budgetID; // Assuming the server returns the budget ID in the response
            //console.log("Budget ID:", budgetID); // Debugging: Log values to check
            const response2 = await fetch("http://localhost:3000/category", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                categoryData,
                budgetID,
              }),
            });
            if (response2.ok) {
              // Successful registration
              alert("Category info submitted successfully!");
              //localStorage.setItem("Budget_ID", Budget_ID);
              window.location.href = "budget.html"; // Redirect to budget.html after successful login
            } else {
              const result = await response2.json();
              alert(result.message || "Failed to submit category info.");
            }
          } else {
            alert("Submission failed. Please try again.");
          }
        });
      function collectCategoryData(categoriesAmount) {
        const categoryDataMap = new Map();

        for (let i = 1; i <= categoriesAmount; i++) {
          const nameInput = document.getElementById(`category_${i}_name`);
          const amountInput = document.getElementById(`category_${i}_max`);

          if (nameInput && amountInput) {
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value);

            if (name && !isNaN(amount)) {
              categoryDataMap.set(name, amount);
            }
          }
        }

        return Array.from(categoryDataMap.entries());
      }
    </script>
  </body>
</html>
